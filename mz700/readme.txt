
▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲

MZ-700 on FPGA for Spartan-3(XC3S1000)

                    取扱い説明書

                2005 (C) Nibbles Lab.

  V1.2a

▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼

【 はじめに 】

MSX や PC-8001 や X1 が FPGA に実装される昨今、我が愛する MZ もワンチップ(*)に
しなきゃ、ということで一念発起して作ってみました。お世辞にも手本と言えないでしょ
うが同様の試みをお考えのどなたかに参考になれば幸いです。

ハードが苦手な方にも体験してもらえるよう、できる限り追加ハードが不要なようにして
あります。ソフトのように書いたものがハードになる、その不思議な感覚を味わってみて
ください。

(*)1chip MSX などこの種の試みを「ワンチップ化」と表現することが多々ありますが、
現実として Z80 のメモリ空間を全て FPGA に取り込むためには最上位クラスの品種を用
いる必要があり、コストがかかりすぎます。
1chip MSX も含めて、メインメモリだけは外部 SRAM や DRAM に頼っています。
便宜上、多くの機能がワンチップに収まるという意味で使うようにしましょう。

【 無保証 】

このバイナリおよびソースの一部または全部を利用ないし流用することにおいて、制作者
と過去の関係者(MZ-700 エミュレータ作者、互換モニタ作者、メーカー含む)はいかなる
損失も補償するものではありません。あくまで個人的な評価・研究・遊技用としてお使い
ください。
なお、ライセンスは特に明記しませんが、BSD ライクに取り扱っていただければ幸いです。

【 特徴 】

*  Xilinx/Digilent 製 Spartan-3 Starter Kit に実装しました。音声以外は特別なハー
ドなしに楽しめるようになっています。
* テープシステムを再現しています。
* 本物と同じ 3.579545MHz クロックを使用していますが、ウェイトの差により違いはあり
ます。
* キーボードは PS/2 ポートに接続した PC 互換機用のキーボードを使用します。機能
よりは配置を似せて実装しています。
* RS-232C ポートに mzt ファイルを送り込むことで、テープの読み込みに対応しました。
残りバイト数が表示されるようになっています。
* キャラクタ印字に限り、プリンタ出力に対応しました。紙の代わりにシリアルポートに
出力します。MZ-1P01 のペンチェンジコマンドにより、色が変るところは再現しています。
* HAL 研究所製 PCG-700 互換の PCG に対応しています。
* 配布イメージのモニタには、MZ-NEW MONITOR を使用しています。もちろん再合成する
ことで 1Z-009A も使用できます。 

【 配布ファイルの内容一覧 】

readme.txt  …  このファイル

spkout.BMP  …  後付けスピーカーの回路図
spkout.CE3

mz700.ise   …  Xilinx ISE7.1 用プロジェクトファイル

mz700.cdf   …  iMPACT 用書き込みファイル生成用設定ファイル
mz700.ipf   …  同、ISE7.1 用
sp3.cdf     …  iMPACT 用 JTAG チェーン設定ファイル
sp3.ipf     …  同、ISE7.1 用

mz700.par   …  配置・配線レポート
mz700.syr   …  合成レポート

prom.psm    …  PicoBlaze ソースファイル  以下、PicoBlaze 関係のファイル
ROM_form.coe
ROM_form.v
ROM_form.vhd
PROM.COE
PROM.VHD

mz700.ucf   …  制約ファイル

mz700.bit   …  回路データ
mz700.mcs

cgrom.vhd   …  以下、回路のソース
counter0.vhd
counter1.vhd
counter2.vhd
dpram2k.vhd
exrom.vhd
i8253.vhd
i8255.vhd
kcpsm3.vhd
keymatrix.vhd
ls367.vhd
memsel.vhd
mrom.vhd
my_dcm1.vhd
my_dcm1.xaw
my_dcm1_arwz.ucf
my_dcm2.vhd
my_dcm2.xaw
my_dcm2_arwz.ucf
mz700.vhd
ps2kb.vhd
psio.vhd
T80.vhd
T80s.vhd
T80_ALU.vhd
T80_MCode.vhd
T80_Pack.vhd
T80_Reg.vhd
vgaout.vhd

【 使い方 】

0) まず、Spartan-3 Starter Kit を用意してください。Digilent でのみ販売している
XC3S1000 使用の製品専用です。この製品は時々品切になることがあります。特別な計画
などがない場合は、XC3S200 使用の製品を入手し、またそれ用のデータをダウンロード
することをおすすめします。

次に ISE を入手・インストールしてください。Xilinx のサイトからダウンロードするか、
キットや雑誌に付属する CD-ROM からインストールしてください。動作させるまで少し
準備が必要ですが、その手順については割愛します。ネットを探せば、情報は得られると
思います。

1) キットに付属するケーブルを、PC のパラレルポートとボードの JTAG ポートに接続し
てください。パラレルポートがない PC もありますが、USB で接続するパラレルポート
ではうまく使えないらしいので、その場合は新たに別のケーブルを入手することになりま
す。Xilinx でも純正の USB ケーブルがありますし、Digilent でも取り扱っています。
あるいはヒューマンデータ製やナヒテック製の JTAG アダプタを使用することもできると
思います。添付ケーブル以外の接続方法が添付ケーブルと同じである保証はありませんの
で、アダプタのドキュメントをよく読んで対応してください。
ケーブルを接続したら、電源を投入してください。

2) iMPACT またはそれに準ずる JTAG 書き込みツールにて、mz700.mcs をボードのフラッ
シュメモリ(XCF02S)に書き込んでください。
2-1) iMPACT を起動してください。スタートメニューから Xilinx ISE*.* などという
メニューを伝えば見つかると思います。
2-2) 何かダイアログが出ると思いますが、キャンセルして消してください。次回以降は
ここで設定ファイルを指定できます。
2-3) File メニューとかオープンボタンなどで sp3.cdf という設定ファイルを開いて
ください。ボードの JTAG チェーンの状態が表示されます。LSI が二つ表示されている
なら正常です。
2-4) 右の xcf02s をクリックして選択し、Operations→Program... とするか、xcf02s の
上で右クリック→Program...とすると書き込みを開始します。
接続など問題がなくても書き込みに失敗することがありますので、根気よくやり直して
ください。

3) J6(左側上のコネクタ) に VGA モニタケーブルを、J4(左側下のコネクタ) に PC から
のシリアルケーブルを、J3(右側下のコネクタ) に PS/2 キーボードケーブルを接続して
ください。キーボードは日本語配列のものを使用してください。

4) 基板上のスイッチ類は以下のとおりです。

 　　 　　 　　 　　 □　□　□　□　□　□　□　■
 ●　 ●　 ●　 ●　 ■　■　■　■　■　■　■　□
BTN3 BTN2 BTN1 BTN0  SW7 SW6 SW5 SW4 SW3 SW2 SW1 SW0

BTN3 リセット
BTN2 未使用
BTN1 未使用
BTN0 未使用
SW7  PCG 切り替え
SW6  未使用
SW5  未使用
SW4  プリンタコード切り替え
SW3  未使用
SW2  未使用
SW1  未使用
SW0  テープ起動

SW7〜0 のスライドスイッチは、上図の黒の側に入れた状態で電源を投入してください。

5) 電源を入れると、7セグメント LED に「７００」と表示され、VGA モニタに

┌────────────────────
│　ＭＺ−７００
│＊■
│
│

とブルーバックに白文字で表示されます。これでモニタ MZ-NEW MONITOR が起動し、コ
マンド待ちとなります。モニタコマンドについては、別途 NEW MONITOR 添付のドキュメ
ントを参照してください。

MZ-NEW MONITOR ダウンロードサイト
http://homepage1.nifty.com/marukun/mz700/kyodaku.html

6) キーボードのうち、特殊キーは次のように割り当ててあります。

F1〜F5 … F1〜F5
GRAPH  … 半角/全角
英数   … Tab
CTRL   … CapsLock
BREAK  … BackSpace
＝     … F9,F11
カナ   … F10,F12

以前のバージョンで INST と DEL をファンクションキーに割り当てていましたが、
今回からそれを解消しキーボードにある Insert と Delete キーに割り当てています。
一部コンパクトキーボードでは F11 と F12 キーが Fn キー併用とされているため、
利便性を考えてイコールとカナを引き続き F9 と F10 にも割り当てています。

また、MZ-NEW MONITOR の仕様上 1Z-009A とは違うキー機能となっているものがありま
す。詳細は MZ-NEW MONITOR のドキュメントを参照してください。

7) そのままでは特にできることもあまりないので、何かシステムをロードしましょう。
まず、モニタにてＬコマンドを入力します。「↓ＰＬＡＹ」と出て、テープ始動待ちに
なります。
シリアルケーブルでつないである PC にて、Tera Term Pro やハイパーターミナルなど
のターミナルソフトを起動し、4800bps、8 ビット長、ストップビット1、パリティなし
設定にて、ロードしたい .mzt や .m12 フォーマットのファイルをXMODEM(128 バイト
サム) モードにて送信します。但しこの時点では送信動作は始まりません。
ここで、SW0 を手前に動かします。7セグメント LED の表示が「００００」と変わり、
ロードが開始されます。ターミナルソフトでも、まず 16 ブロックの送信が行われると
思います。VGA モニタにロードするファイル名が表示される頃、そのファイルの大きさ
が 16 進数で LED に表示されます。そのうちそれがダウンカウントし、ゼロになると
ロードが完了します。完了したら SW0 を元に戻しておいてください。

多段ロードの必要なプログラムの場合でも、MZ700WIN と同様に必要なファイルを連結
したものを転送すれば、読み込ませられると思います。連結は

ヘッダ１＋データ１＋ヘッダ２＋データ２＋…

としたものに限ります。

8) PCG 対応のソフトでは、SW7 を切り替えることで定義されたフォントの表示になり
ます。

9) プリンタに出力すると、シリアルケーブルでつないである PC のターミナルソフトの
画面に印字した文字が表示されます。ANSI エスケープシーケンスに対応したターミナル
なら、MZ-1P01(内蔵プロッタプリンタ) のペンチェンジに応じた色にて表示が行われま
す。表示上意味のないコントロールコードはカットします。またターミナルソフトで
表示できない文字の出力についてはその動作を保証しません。
なお SW4 を上側に変更すると、全てのコントロールコードをシリアルに出力するように
なります(ANSI エスケープシーケンスへの読み替えは行われません)。

10) 音もちゃんと出ますが、スピーカーが必要です。7セグメント LED の左横にある、
8 ピンの IC ソケット (IC8) の 5 番ピンから音が出力されています。私は spkout.BMP
にあるような回路を取り付けていますが、偽X1(仮)のように無電源スピーカーでも十分
だと思われます。

偽X1(仮)
http://members.at.infoseek.co.jp/x1resource/x1clone/x1clone.htm

【 制限 】

* VGAモニタにしか接続できません。コンポジットビデオへの出力回路もありません。例え
それを実装しても、出力にはいくらかの外付け回路の追加が必要です。
* MZ フォーマットのテープ入力について、これ以外のフォーマットには対応していませ
ん。
例えば、TS-700 モニタではテープからの読み込みはできません。PicoBlaze のプログラム
エリアとスイッチに余りはあるので、フォーマットさえわかれば対応は不可能ではないで
しょう。
* 多段ロードのうち、途中のヘッダがないもの、ボーレートを変更するものなども対応でき
ません。
* 同様にテープ出力はサポートしていません。やりようはあるとは思っています。
* ビデオのタイミングが VGA を基準にしているだけに、本物と違いがあります。野球拳
2000 バージョンのようにブランキング信号を厳密に参照するようなプログラムは期待した
動作をしません(その前に現時点では水平ブランキング信号を省略していますが…)。
* 著作権問題回避のためモニタに MZ-NEW MONITOR を使っていますが、これは SP-1002
互換のため一部のソフトが機種を誤認識することがあります。手元では、マッピーがそれ
に相当します。マッピーについては、.mzt ファイルの 1486h 番地から 21 20 00 と変更
することで強制的に MZ-700 として認識させることができます。
* たまに、XMODEM 転送がうまくいかない時があります。PC 側の進行表示が異様に速く
進んだり、ロードバイト数が変な値だったりで判別できると思います。その時はやりなお
してください。特にリセットなどの必要もありません。

【 ソースについて 】

以下に、モジュールのツリーの形式を示しながらそれぞれの機能を説明します。ソースを
読むときの参考にしてください。

*- mz700.vhd
|   メインモジュール。各サブモジュールの配置と、データバスセレクト、7セグメント
|   LED の表示、クロック生成など雑多な回路が入っています。
|
*- cgrom.vhd
|   フォント ROM/PCG モジュール。ROM データは MZ-700 エミュレータの「見た目コピー
|   フォント」を使わせていただいています。
|   PCG は同期系ゆえ本物と若干タイミングが違うかもしれませんが、定義できるので
|   良しとしています。
|
*- dpram2k.vhd
|   VRAM とアトリビュート RAM のためのデュアルポートメモリモジュールです。本物
|   の MZ ではシングルポートメモリを表示回路と CPU が競合しながらアクセスして
|   いたのですが、簡単に済ませるためデュアルポート構成にしました。そのため、
|   ブランキングチェックなしでもウェイトのないアクセスが可能です。
|
*- exrom.vhd
|   拡張 ROM モジュール。NEW MONITOR が SP-1002 互換のためアトリビュートエリアを
|   初期化してくれません。そのままでは真っ暗なので、MZ-1500 の拡張モニタと同じ
|   位置にアトリビュートを初期化だけするプログラムが納められた ROM を配置してい
|   ます。
|
*- i8253.vhd
|  +- counter0.vhd
|  +- counter1.vhd
|  +- counter2.vhd
|   インテル 8253 互換のモジュールです。本物はあまりにモードが多くて実装がたい
|   へんだったので、使用するモードのみに絞って実装しています。そのため、もしか
|   するとうまく動かないプログラムがあるかもしれません。
|
*- i8255.vhd
|  +- keymatrix.vhd
|     +- ps2kb.vhd
|   インテル 8255 互換のモジュールです。周辺回路が決まっているため入出力方向
|   設定など一部の機能を実装していません。
|   またここにキーボード入力回路もあります。PS/2 キーボードからの信号パターンに
|   より、対応するフリップフロップをオンオフし、それをキーマトリクスと同様に
|   並べることで本物と全く同じアクセスにてキー入力ができるようにしました。
|   原理上同時キー入力もできるはずです。
|
*- ls367.vhd
|   音楽再生のためのテンポ用クロック生成と、トーンジェネレータ (8253) 動作制御
|   を司るブロックです。水平ブランキング信号が必要な場合はここに追加することに
|   なります。
|
*- memsel.vhd
|   バンクメモリ制御レジスタと各メモリへのチップセレクト信号を生成するブロック
|   です。
|
*- mrom.vhd
|   モニタ ROM ブロック。配布用には NEW MONITOR を入れています。1Z-009A に変える
|   場合は、そのバイナリを何らかの方法でテキスト化して 2KB ずつに分け、それぞれ
|   を今あるものと入れ替えてください。本来ブロック RAM に対する初期値は１行の中
|   で降順に並ぶものですが、一部のアドレス線を反転させているのでそのまま配置でき
|   ます。
|
*- my_dcm1.xaw
*- my_dcm2.xaw
|   ボードにある 50MHz クロックを 28.63636MHz に落とす DCM モジュール定義ファイル
|   です。２つの DCM をカスケードして使用しています。普通はこの .xaw ファイルの
|   みあればよいのですが、カスケード時に後段の入力のクロックバッファでエラーと
|   レポートされ、使用できません。そこで一度 .vhd を出力させてから、後段の入力部
|   のクロックバッファを削除する修正を行ってから合成しています。
|   なおここで生成した 28.63636MHz はメインモジュールにて８分周され、CPU 用の
|   3.579545MHz となります。
|
*- psio.vhd
|  +- kcpsm3.vhd
|  +- PROM.VHD
|   プリンタとシリアル I/O を一手に引き受けるモジュールです。kcpm3.vhd は PicoBlaze
|   そのもので、PROM.VHD にそのプログラムが納められています。
|   psio.vhd には RS-232C のシリアル入出力と、プリンタデータ受信回路、テープ I/F
|   のためのシャープ PWM 方式ビット生成回路があります。これらの制御を PicoBlaze
|   が担当しています。
|
*- T80s.vhd
|  +- T80.vhd
|  +- T80_ALU.vhd
|  +- T80_MCode.vhd
|  +- T80_Reg.vhd
|   OPENCORES で公開されている Z80 互換ＩＰコア、T80 です。同期用ラッパー T80s
|   を使っています。データバスの入出力が分かれており、このモジュールの外で双
|   方向制御をしなくてすむのが楽でいいです。
|
*- vgaout.vhd
    VGA モニタ用同期信号生成と、そのタイミングに合わせた表示データ出力のモジュール
    です。

合成および配置・配線は ISE7.1 にて処理しています。配置・配線後の使用率は以下のと
おりとなりました。

   Number of BUFGMUXs                  8 out of 8     100%
   Number of DCMs                      2 out of 4      50%
   Number of External IOBs            67 out of 173    38%
      Number of LOCed IOBs            67 out of 67    100%

   Number of RAMB16s                   9 out of 24     37%
   Number of Slices                 1882 out of 7680   24%
      Number of SLICEMs               83 out of 3840    2%

さすが、XC3S1000 はデカいですね〜。

【 謝辞 】

本プロジェクトにあたり、次の方々による情報や成果物を使用または参照させていただい
ております。この場をもってお礼を申し上げます。

* Spartan-3 Starter Kit の使い始めにあたり、X1 リソースセンターのさとうさんによ
る「ザイリンクスでいこう」内の「Spartan-3 Starter Kit」の情報を参考にさせていた
だいています。

    X1リソースセンター
    http://members.at.infoseek.co.jp/x1resource/

    ザイリンクスでいこう
    http://members.at.infoseek.co.jp/x1resource/xilinx/index.htm

    Spartan-3 Starter Kit
    http://members.at.infoseek.co.jp/x1resource/xilinx/sp3/sp3stkit.htm

* OPENCORES で公開されている T80 を使用させていただいています。 

    OPENCORES
    http://www.opencores.org

    T80
    http://www.opencores.org/projects.cgi/web/t80/overview

* CG-ROM フォントとして、mz700win に付属するデータから生成した「見た目コピーフォ
ント」を使用させていただいています。

    MZ-700 Emulator MZ700WIN For Windows9x/Me/NT/2000
    http://homepage1.nifty.com/marukun/mz700/index.html

* モニタ ROM のデータとして、互換モニタ「MZ-NEW MONITOR」を使用させていただいて
います。

    MZ-NEW MONITOR
    http://homepage1.nifty.com/marukun/mz700/kyodaku.html

【 その他 】

この作品に関するご感想などは、Ｏｈ！石 ( ohishi.nobuaki@nifty.ne.jp ) までメール
をお送りください。

MZ をつくる
http://www.retropc.net/ohishi/mzbyfpga/index.htm

